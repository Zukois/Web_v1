<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MQTT Dashboard</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- MQTT.js -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Canvas-Gauges -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-gauges/gauge.min.js"></script>
</head>

<body class="bg-gray-900 text-white flex flex-col items-center justify-center min-h-screen p-6">
    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 text-center w-full max-w-xl">
        <h1 class="text-3xl font-bold mb-4 text-blue-400">MQTT Live Dashboard</h1>

        <!-- MQTT Status -->
        <div id="mqtt-status" class="mb-6 text-sm font-medium text-gray-300">
            <span class="inline-block px-3 py-1 rounded-full bg-red-500 text-white">Disconnected</span>
        </div>

        <!-- Analog Gauge -->
        <canvas id="gaugeCanvas" width="300" height="300" class="mx-auto mb-6"></canvas>

        <!-- Topic Info -->
        <p class="text-sm mt-2 text-gray-400">Topik: <span id="topic-label">sensor/gauge</span></p>

        <!-- Chart -->
        <div class="mt-8">
            <canvas id="gaugeChart" height="200"></canvas>
        </div>

        <!-- Control Buttons -->
        <div class="mt-8 grid grid-cols-2 gap-4">
            <button onclick="sendControl('ON')"
                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-2xl shadow-lg transition-all duration-200">
                ON
            </button>
            <button onclick="sendControl('OFF')"
                class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-2xl shadow-lg transition-all duration-200">
                OFF
            </button>
            <button onclick="sendControl('MODE1')"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-2xl shadow-lg transition-all duration-200">
                MODE 1
            </button>
            <button onclick="sendControl('MODE2')"
                class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-2xl shadow-lg transition-all duration-200">
                MODE 2
            </button>
        </div>
    </div>

    <script>
        const broker = 'ws://broker.emqx.io:8083/mqtt';
        const topic = 'bru/cba';
        let currentValue = 0;

        // Manual Inisialisasi Gauge
        const gauge = new RadialGauge({
            renderTo: 'gaugeCanvas',
            width: 300,
            height: 300,
            units: "Value",
            title: "Sensor",
            minValue: 0,
            maxValue: 100,
            majorTicks: ["0", "20", "40", "60", "80", "100"],
            minorTicks: 4,
            strokeTicks: true,
            highlights: [
                { from: 0, to: 50, color: "rgba(74,222,128,0.3)" },
                { from: 50, to: 80, color: "rgba(250,204,21,0.3)" },
                { from: 80, to: 100, color: "rgba(248,113,113,0.4)" }
            ],
            colorPlate: "#1f2937",
            colorMajorTicks: "#ccc",
            colorMinorTicks: "#ccc",
            colorTitle: "#fff",
            colorUnits: "#ccc",
            colorNumbers: "#eee",
            colorNeedleStart: "rgba(255, 255, 255, 1)",
            colorNeedleEnd: "rgba(255, 255, 255, .9)",
            animationRule: "bounce",
            animationDuration: 500,
            value: 0
        }).draw();

        // MQTT connect
        const client = mqtt.connect(broker);

        // MQTT status label update
        const mqttStatus = document.getElementById('mqtt-status');

        // Chart.js setup
        const ctx = document.getElementById('gaugeChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Data Sensor',
                    data: [],
                    fill: true,
                    borderColor: '#4ade80',
                    backgroundColor: 'rgba(74, 222, 128, 0.1)',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#ccc' },
                        grid: { color: '#333' }
                    },
                    x: {
                        ticks: { color: '#ccc' },
                        grid: { display: false }
                    }
                }
            }
        });

        // MQTT Events
        client.on('connect', () => {
            console.log('Terhubung ke MQTT broker');
            mqttStatus.innerHTML =
                `<span class="inline-block px-3 py-1 rounded-full bg-green-500 text-white">Connected</span>`;
            client.subscribe(topic, (err) => {
                if (!err) {
                    document.getElementById('topic-label').innerText = topic;
                }
            });
        });

        client.on('close', () => {
            mqttStatus.innerHTML =
                `<span class="inline-block px-3 py-1 rounded-full bg-red-500 text-white">Disconnected</span>`;
        });

        client.on('error', (err) => {
            console.error('MQTT Error:', err);
            mqttStatus.innerHTML =
                `<span class="inline-block px-3 py-1 rounded-full bg-red-500 text-white">Error</span>`;
        });

        client.on('message', (topic, message) => {
            const newValue = parseFloat(message.toString());
            gauge.value = newValue;
            currentValue = newValue;

            // Update grafik
            const timeLabel = new Date().toLocaleTimeString();
            chart.data.labels.push(timeLabel);
            chart.data.datasets[0].data.push(newValue);
            if (chart.data.labels.length > 20) {
                chart.data.labels.shift();
                chart.data.datasets[0].data.shift();
            }
            chart.update();
        });
        // Fungsi kirim kontrol ke MQTT
        function sendControl(command) {
            const controlTopic = 'kontrol/perangkat';
            client.publish(controlTopic, command);
            console.log(`Kirim ke ${controlTopic}: ${command}`);
        }
    </script>
</body>

</html>
